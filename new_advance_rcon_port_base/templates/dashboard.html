<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tempest PZ Manager - Dashboard</title>
    <link rel="icon" href="{{ get_secure_image_url('server_logo') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&family=JetBrains+Mono&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dark-theme.css') }}">
    <script src="{{ url_for('static', filename='js/hostname-to-ip.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* Add to the existing style section */
        .copyable {
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-block;
        }

        .copyable:hover {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            padding: 2px 4px;
            margin: -2px -4px;
        }

        .copy-icon {
            opacity: 0;
            transition: opacity 0.2s ease;
            cursor: pointer;
            color: var(--accent-color);
        }

        .copyable:hover+.copy-icon,
        .copy-icon:hover {
            opacity: 1;
        }

        div:hover>.copy-icon {
            opacity: 0.7;
        }

        .swal2-popup {
            background-color: var(--panel-bg);
            color: var(--text-color);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
        }

        .swal2-title,
        .swal2-html-container {
            color: var(--text-color);
        }

        .swal2-confirm {
            background-color: var(--accent-color) !important;
            box-shadow: var(--shadow-sm) !important;
            border-radius: var(--radius-md) !important;
            transition: all 0.2s ease !important;
        }

        .swal2-confirm:hover {
            background-color: var(--accent-hover) !important;
            transform: translateY(-2px) !important;
            box-shadow: var(--shadow-md) !important;
        }

        .swal2-cancel {
            background-color: rgba(255, 255, 255, 0.1) !important;
            color: var(--text-color) !important;
            border-radius: var(--radius-md) !important;
            transition: all 0.2s ease !important;
            box-shadow: var(--shadow-sm) !important;
        }

        .swal2-cancel:hover {
            background-color: rgba(255, 255, 255, 0.2) !important;
            transform: translateY(-2px) !important;
            box-shadow: var(--shadow-md) !important;
        }

        .swal2-icon {
            border-color: var(--accent-color) !important;
        }

        .swal2-timer-progress-bar {
            background: var(--accent-color);
        }
    </style>
    <style>
        .stats-card {
            border-left: 4px solid #0d6efd;
            transition: transform 0.2s;
        }

        .stats-card:hover {
            transform: translateY(-5px);
        }

        .stats-card .icon {
            font-size: 2rem;
            opacity: 0.7;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #6c757d;
        }

        .progress {
            height: 8px;
            margin-top: 8px;
        }

        #server-stats-panel {
            background-color: #1e2131;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .nav-tabs {
            border-bottom: 1px solid #2c3154;
            margin-bottom: 1.5rem;
        }

        .nav-tabs .nav-item {
            margin-bottom: -1px;
        }

        .nav-tabs .nav-link {
            color: #adb5bd;
            border: 1px solid transparent;
            border-top-left-radius: 0.25rem;
            border-top-right-radius: 0.25rem;
            padding: 0.75rem 1.25rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .nav-tabs .nav-link:hover {
            color: #fff;
            border-color: transparent;
            background-color: rgba(255, 255, 255, 0.05);
        }

        .nav-tabs .nav-link.active {
            color: #fff;
            background-color: #2c3154;
            border-color: #2c3154 #2c3154 #2c3154;
            border-bottom: 3px solid #0d6efd;
        }

        .nav-tabs .nav-link i {
            margin-right: 0.5rem;
        }

        .tab-content {
            padding: 0.5rem;
        }

        .tab-pane {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .server-quick-actions {
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .server-quick-actions:hover {
            opacity: 1;
        }

        .server-quick-actions .btn:hover {
            transform: scale(1.2);
        }

        .card-collapsed {
            cursor: pointer;
            max-height: 90px;
            overflow: hidden;
            transition: background-color 0.2s;
        }

        .fix-dashboard {
            width: auto;
            /* Changed from fixed 400px */
            min-width: 350px;
            /* Minimum width for cards */
        }


        .card-collapsed:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .server-card-3d:not(.card-collapsed) {
            cursor: pointer;
        }

        .server-card-3d:not(.card-collapsed):hover {
            background-color: rgba(255, 255, 255, 0.02);
        }

        .server-quick-actions,
        a {
            position: relative;
            z-index: 10;
        }

        /* Server card animations */
        .server-card-add {
            animation: server-card-add-animation 0.5s ease-out forwards;
            transform-origin: center;
            opacity: 0;
        }

        @keyframes server-card-add-animation {
            from {
                transform: scale(0.8);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .server-card-remove {
            animation: server-card-remove-animation 0.5s ease-out forwards;
            transform-origin: center;
        }

        @keyframes server-card-remove-animation {
            from {
                transform: scale(1);
                opacity: 1;
            }

            to {
                transform: scale(0.8);
                opacity: 0;
            }
        }

        /* Status indicator pulse animation for loading states */
        .status-loading,
        .status-restarting,
        .status-creating {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.6;
            }
        }
    </style>
</head>

<body data-clear-cache="{{ clear_cache|lower }}" {% if is_admin %}data-is-admin="true" {% endif %}>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('dashboard') }}">
                <i class="bi bi-hdd-network me-2"></i>Tempest PZ Manager
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    {% if is_admin %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('users') }}">
                            <i class="bi bi-people me-1"></i> Manage Users
                        </a>
                    </li>
                    {% endif %}
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('logout') }}">
                            <i class="bi bi-box-arrow-right me-1"></i> Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category }}">
            {{ message }}
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}
        <!-- Tabs Navigation -->
        <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="servers-tab" data-bs-toggle="tab" data-bs-target="#servers-pane"
                    type="button" role="tab" aria-controls="servers-pane" aria-selected="true">
                    <i class="bi bi-hdd-rack"></i> Server Management
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats-pane" type="button"
                    role="tab" aria-controls="stats-pane" aria-selected="false">
                    <i class="bi bi-speedometer2"></i> Server Statistics
                </button>
            </li>
            <!--
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="queue-tab" data-bs-toggle="tab" data-bs-target="#queue-pane" type="button"
                    role="tab" aria-controls="queue-pane" aria-selected="false">
                    <i class="bi bi-hourglass-split"></i> In Queue Servers
                </button>
            </li>
        -->
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="dashboardTabContent">
            <!-- Servers Management Tab -->
            <div class="tab-pane fade show active" id="servers-pane" role="tabpanel" aria-labelledby="servers-tab">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-hdd-rack me-2"></i>Server Management</h2>
                    {% if is_admin %}
                    <a href="{{ url_for('create_server_route') }}" class="btn btn-primary btn-3d">
                        <i class="bi bi-plus-circle me-2"></i> Create Server
                    </a>
                    {% endif %}
                </div>

                {% if servers|length == 0 %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i> No servers have been created yet.
                </div>
                {% else %}
                <div class="row">
                    {% for server_name, server in servers.items() %}
                    <div class="col-md-4 mb-4 fix-dashboard">
                        <div class="card server-card-3d h-100">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0" data-server-name="{{ server.name }}">
                                    <span class="server-status-indicator status-{{ server.status }}"></span>
                                    {{ server.name }}

                                    <!-- Add action buttons for server control -->
                                    <div class="server-quick-actions ms-2 d-inline-flex">
                                        {% if server.status == 'running' %}
                                        <button class="btn btn-sm btn-link text-light p-0 ms-1"
                                            onclick="restartServer('{{ server.name }}')" title="Restart Server">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                        <button class="btn btn-sm btn-link text-light p-0 ms-1"
                                            onclick="stopServer('{{ server.name }}')" title="Stop Server">
                                            <i class="bi bi-stop-fill"></i>
                                        </button>
                                        {% else %}
                                        <button class="btn btn-sm btn-link text-light p-0 ms-1"
                                            onclick="startServer('{{ server.name }}')" title="Start Server">
                                            <i class="bi bi-play-fill"></i>
                                        </button>
                                        {% endif %}
                                        {% if is_admin %}
                                        <button class="btn btn-sm btn-link text-danger p-0 ms-1"
                                            onclick="confirmDeleteServer('{{ server.name }}')" title="Delete Server">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                        {% endif %}
                                    </div>
                                </h5>
                                <span class="badge bg-{{ 'success' if server.status == 'running' else 'danger' }}">
                                    {{ server.status }}
                                </span>
                            </div>
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <i class="bi bi-globe me-2 text-muted"></i>
                                    <div>
                                        <div class="text-muted small">Server IP</div>
                                        <div class="server-ip-display" id="hostip">{{ request.host.split(':')[0] }}
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex align-items-center mb-3">
                                    <i class="bi bi-key me-2 text-muted"></i>
                                    <div>
                                        <div class="text-muted small">Server Password</div>
                                        <div class="d-flex align-items-center">
                                            <span id="server-password-{{ server.name }}" class="password-hidden">
                                                {% if server.server_password %}•••••••••{% else %}None{% endif %}
                                            </span>
                                            <i class="bi bi-eye password-toggle ms-2"
                                                onclick="togglePassword('server-password-{{ server.name }}', '{{ server.server_password }}')"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex align-items-center mb-3">
                                    <i class="bi bi-shield-lock me-2 text-muted"></i>
                                    <div>
                                        <div class="text-muted small">Admin Password</div>
                                        <div class="d-flex align-items-center">
                                            <span id="admin-password-{{ server.name }}"
                                                class="password-hidden">•••••••••</span>
                                            <i class="bi bi-eye password-toggle ms-2"
                                                onclick="togglePassword('admin-password-{{ server.name }}', '{{ server.admin_password }}')"></i>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex align-items-center mb-3">
                                    <i class="bi bi-ethernet me-2 text-muted"></i>
                                    <div>
                                        <div class="text-muted small">Game Port</div>
                                        <div id="gameport">{{ server.port }}</div>
                                    </div>
                                </div>

                                <div class="d-flex align-items-center mb-3">
                                    <i class="bi bi-broadcast me-2 text-muted"></i>
                                    <div>
                                        <div class="text-muted small">Query Port</div>
                                        <div id="query_portport">{{ server.query_port }}</div>
                                    </div>
                                </div>

                                <div class="d-flex align-items-center mb-3">
                                    <i class="bi bi-calendar-event me-2 text-muted"></i>
                                    <div>
                                        <div class="text-muted small">Created</div>
                                        <div>{{ server.created_at }}</div>
                                    </div>
                                </div>

                                {% if server.status == 'running' %}
                                <!-- Server Usage Statistics (only shown for running servers) -->
                                <hr>
                                <h6 class="text-primary mb-3"><i class="bi bi-graph-up me-2"></i>Server Usage</h6>

                                <!-- CPU Usage -->
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="text-muted small">CPU Usage</span>
                                        <span class="small server-cpu-{{ server.name }}">--%</span>
                                    </div>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-primary server-cpu-progress-{{ server.name }}"
                                            role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>

                                <!-- Memory Usage -->
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="text-muted small">Memory</span>
                                        <span class="small server-memory-{{ server.name }}">-- MB</span>
                                    </div>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-success server-memory-progress-{{ server.name }}"
                                            role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>

                                <!-- Disk Usage -->
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="text-muted small">Disk Usage</span>
                                        <span class="small server-disk-{{ server.name }}">-- MB</span>
                                    </div>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-warning server-disk-progress-{{ server.name }}"
                                            role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>

                                <!-- Network -->
                                <div class="mb-2">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="text-muted small">Network</span>
                                        <span class="small server-network-{{ server.name }}">-- KB/s</span>
                                    </div>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-info server-network-progress-{{ server.name }}"
                                            role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>

                                <!-- Uptime -->
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-clock-history me-2 text-muted small"></i>
                                    <div class="small">
                                        <span class="text-muted">Uptime:</span>
                                        <span class="server-uptime-{{ server.name }}">--:--:--</span>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            <div class="card-footer">
                                <a href="{{ url_for('server_control', server_name=server.name) }}"
                                    class="btn btn-info btn-3d w-100">
                                    <i class="bi bi-gear-fill me-2"></i> Manage
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- Server Statistics Tab -->
            <div class="tab-pane fade" id="stats-pane" role="tabpanel" aria-labelledby="stats-tab">
                <!-- Server Stats Panel -->
                <div id="server-stats-panel" class="p-4 mb-4">
                    <h4 class="mb-3"><i class="bi bi-speedometer2 me-2"></i>System Statistics</h4>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="card stats-card h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="stat-label">CPU Usage</div>
                                            <div class="stat-value" id="cpu-usage">0%</div>
                                        </div>
                                        <div class="icon text-primary">
                                            <i class="bi bi-cpu"></i>
                                        </div>
                                    </div>
                                    <div class="progress">
                                        <div id="cpu-progress" class="progress-bar bg-primary" role="progressbar"
                                            style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card stats-card h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="stat-label">Memory Usage</div>
                                            <div class="stat-value" id="memory-usage">0 GB</div>
                                        </div>
                                        <div class="icon text-success">
                                            <i class="bi bi-memory"></i>
                                        </div>
                                    </div>
                                    <div class="progress">
                                        <div id="memory-progress" class="progress-bar bg-success" role="progressbar"
                                            style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card stats-card h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="stat-label">Disk Usage</div>
                                            <div class="stat-value" id="disk-usage">0 GB</div>
                                        </div>
                                        <div class="icon text-warning">
                                            <i class="bi bi-hdd"></i>
                                        </div>
                                    </div>
                                    <div class="progress">
                                        <div id="disk-progress" class="progress-bar bg-warning" role="progressbar"
                                            style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card stats-card h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="stat-label">Network Traffic</div>
                                            <div class="stat-value" id="network-traffic">0 MB/s</div>
                                        </div>
                                        <div class="icon text-info">
                                            <i class="bi bi-globe"></i>
                                        </div>
                                    </div>
                                    <div class="progress">
                                        <div id="network-progress" class="progress-bar bg-info" role="progressbar"
                                            style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="card stats-card h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="stat-label">Uptime</div>
                                            <div class="stat-value" id="uptime">0d 0h 0m</div>
                                        </div>
                                        <div class="icon text-danger">
                                            <i class="bi bi-clock-history"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card stats-card h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="stat-label">Active Servers</div>
                                            <div class="stat-value" id="active-servers">0</div>
                                        </div>
                                        <div class="icon text-secondary">
                                            <i class="bi bi-hdd-rack"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card stats-card h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="stat-label">Load Average</div>
                                            <div class="stat-value" id="load-average">0.00</div>
                                        </div>
                                        <div class="icon text-primary">
                                            <i class="bi bi-graph-up"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card stats-card h-100">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="stat-label">Server Temperature</div>
                                            <div class="stat-value" id="temperature">0°C</div>
                                        </div>
                                        <div class="icon text-danger">
                                            <i class="bi bi-thermometer-half"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="text-end mt-2">
                        <small class="text-muted">Last updated: <span id="last-updated">Never</span></small>
                        <button id="refresh-stats" class="btn btn-sm btn-outline-light ms-2">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                </div>

                <!-- Servers Performance Overview Section -->
                <div class="mt-4">
                    <h4 class="mb-3"><i class="bi bi-bar-chart-line me-2"></i>Servers Performance Overview</h4>
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover table-borderless">
                                    <thead>
                                        <tr>
                                            <th>Server Name</th>
                                            <th>Status</th>
                                            <th>CPU</th>
                                            <th>Memory</th>
                                            <th>Disk</th>
                                            <th>Network</th>
                                            <th>Uptime</th>
                                        </tr>
                                    </thead>
                                    <tbody id="servers-stats-table">
                                        {% for server_name, server in servers.items() %}
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <span
                                                        class="server-status-indicator status-{{ server.status }} me-2"></span>
                                                    {{ server.name }}
                                                </div>
                                            </td>
                                            <td>
                                                <span
                                                    class="badge bg-{{ 'success' if server.status == 'running' else 'danger' }}">
                                                    {{ server.status }}
                                                </span>
                                            </td>
                                            <td class="server-cpu-{{ server.name }}">--</td>
                                            <td class="server-memory-{{ server.name }}">--</td>
                                            <td class="server-disk-{{ server.name }}">--</td>
                                            <td class="server-network-{{ server.name }}">--</td>
                                            <td class="server-uptime-{{ server.name }}">--</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- In Queue Servers Tab -->
            <div class="tab-pane fade" id="queue-pane" role="tabpanel" aria-labelledby="queue-tab">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="bi bi-hourglass-split me-2"></i>In Queue Servers</h2>
                    <button id="refresh-queue" class="btn btn-primary btn-3d">
                        <i class="bi bi-arrow-clockwise me-2"></i> Refresh
                    </button>
                </div>

                <div id="queue-servers-container">
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Server Name</th>
                                            <th>Status</th>
                                            <th>Started</th>
                                            <th>Duration</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="queue-servers-table">
                                        <!-- This will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div id="no-queue-message" class="alert alert-info mt-3" style="display: none;">
                        <i class="bi bi-info-circle me-2"></i> No servers are currently in the creation queue.
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Main JavaScript for dashboard.html

        // Global variables for streams
        let statusStream = null;
        let statsStream = null;
        let creationSessionsStream = null;
        let cachedServersList = [];

        // Server management functions
        function togglePassword(elementId, password) {
            const element = document.getElementById(elementId);
            const icon = element.nextElementSibling;

            // Stop event propagation
            event.stopPropagation();

            if (element.classList.contains('password-hidden')) {
                element.textContent = password || 'None';
                element.classList.remove('password-hidden');
                icon.classList.remove('bi-eye');
                icon.classList.add('bi-eye-slash');
                icon.classList.add('copy-icon')
            } else {
                element.textContent = password ? '•••••••••' : 'None';
                element.classList.add('password-hidden');
                icon.classList.remove('bi-eye-slash');
                icon.classList.add('bi-eye');
                icon.classList.remove('copy-icon')
            }
        }

        function initServersListStream() {
            const serversStream = new EventSource('/api/servers-list-stream');

            serversStream.addEventListener('servers_update', function (event) {
                const data = JSON.parse(event.data);
                cachedServersList = data.servers;
                updateServersList(data.servers);
            });

            serversStream.addEventListener('error', function (event) {
                console.error('Servers list stream error:', event.data);
                // Reconnect after error
                setTimeout(initServersListStream, 5000);
            });

            // Handle connection errors
            serversStream.onerror = function (error) {
                console.error('Servers list stream connection error:', error);
                serversStream.close();
                // Reconnect after connection error
                setTimeout(initServersListStream, 5000);
            };
        }
        // Real-time server card updates
        function updateServerCard(serverName, status, data) {
            // Find all server cards with this name
            const serverCards = document.querySelectorAll(`.server-card-3d`);

            serverCards.forEach(card => {
                const serverNameEl = card.querySelector(`h5[data-server-name="${serverName}"]`);
                if (!serverNameEl) return;

                // Update status indicator and badge
                const statusIndicator = serverNameEl.querySelector('.server-status-indicator');
                const statusBadge = card.querySelector('.badge');

                if (statusIndicator) {
                    statusIndicator.className = `server-status-indicator status-${status}`;
                }

                if (statusBadge) {
                    statusBadge.textContent = status;
                    statusBadge.className = 'badge';

                    // Add appropriate color class
                    switch (status) {
                        case 'running':
                            statusBadge.classList.add('bg-success');
                            break;
                        case 'loading':
                        case 'started':
                            statusBadge.classList.add('bg-info');
                            break;
                        case 'restarting':
                        case 'stopping':
                            statusBadge.classList.add('bg-warning');
                            break;
                        case 'stopped':
                        case 'failed':
                            statusBadge.classList.add('bg-danger');
                            break;
                        case 'creating':
                            statusBadge.classList.add('bg-primary');
                            break;
                        default:
                            statusBadge.classList.add('bg-secondary');
                    }
                }

                // Update action buttons
                updateServerActionButtons(serverName, status);

                // Disable buttons if status is creating
                const quickActions = card.querySelector('.server-quick-actions');
                const manageButton = card.querySelector('a.btn-info');
                if (status === 'creating') {
                    if (quickActions) {
                        quickActions.querySelectorAll('button').forEach(button => {
                            button.disabled = true;
                        });
                    }
                    if (manageButton) {
                        manageButton.classList.add('disabled');
                        manageButton.setAttribute('aria-disabled', 'true');
                    }
                } else {
                    if (quickActions) {
                        quickActions.querySelectorAll('button').forEach(button => {
                            button.disabled = false;
                        });
                    }
                    if (manageButton) {
                        manageButton.classList.remove('disabled');
                        manageButton.removeAttribute('aria-disabled');
                    }
                }

                // Update usage statistics if status is running
                if (status === 'running' || status === 'started') {
                    // If we have stats data, update it
                    if (data && data.servers && data.servers[serverName]) {
                        const serverStats = data.servers[serverName];

                        // Update usage statistics
                        const cpuEl = card.querySelector(`.server-cpu-${serverName}`);
                        const memoryEl = card.querySelector(`.server-memory-${serverName}`);
                        const diskEl = card.querySelector(`.server-disk-${serverName}`);
                        const networkEl = card.querySelector(`.server-network-${serverName}`);
                        const uptimeEl = card.querySelector(`.server-uptime-${serverName}`);

                        if (cpuEl) cpuEl.textContent = `${serverStats.cpu_usage}%`;
                        if (memoryEl) memoryEl.textContent = `${serverStats.memory_usage} MB`;
                        if (diskEl) diskEl.textContent = `${serverStats.disk_usage} MB`;
                        if (networkEl) networkEl.textContent = `${serverStats.network_traffic} KB/s`;
                        if (uptimeEl) uptimeEl.textContent = serverStats.uptime;

                        // Update progress bars
                        const cpuProgressEl = card.querySelector(`.server-cpu-progress-${serverName}`);
                        const memoryProgressEl = card.querySelector(`.server-memory-progress-${serverName}`);
                        const diskProgressEl = card.querySelector(`.server-disk-progress-${serverName}`);
                        const networkProgressEl = card.querySelector(`.server-network-progress-${serverName}`);

                        if (cpuProgressEl) cpuProgressEl.style.width = `${serverStats.cpu_usage}%`;
                        if (memoryProgressEl) memoryProgressEl.style.width = `${serverStats.memory_percentage}%`;
                        if (diskProgressEl) diskProgressEl.style.width = `${serverStats.disk_percentage}%`;
                        if (networkProgressEl) networkProgressEl.style.width = `${Math.min(serverStats.network_percentage, 100)}%`;
                    }
                }
            });

            // Update server stats table if it exists
            const serverRows = document.querySelectorAll('#servers-stats-table tr');
            serverRows.forEach(row => {
                const nameCell = row.querySelector('td:first-child');
                if (nameCell && nameCell.textContent.includes(serverName)) {
                    const statusIndicator = nameCell.querySelector('.server-status-indicator');
                    if (statusIndicator) {
                        statusIndicator.className = `server-status-indicator status-${status} me-2`;
                    }

                    const statusCell = row.querySelector('td:nth-child(2) .badge');
                    if (statusCell) {
                        statusCell.textContent = status;
                        statusCell.className = `badge bg-${status === 'running' ? 'success' : 'danger'}`;
                    }
                }
            });

            // Update dashboard counters
            updateDashboardCounts();
        }

        function handleNewServer(serverName, data) {
            // Check if the server already exists in the UI
            if (document.querySelector(`h5[data-server-name="${serverName}"]`)) {
                return;
            }

            // Get the server row container
            const serverRow = document.querySelector('#servers-pane .row');
            if (!serverRow) return;

            // Check if we have alert for no servers
            const noServersAlert = document.querySelector('#servers-pane .alert-info');
            if (noServersAlert) {
                noServersAlert.remove();
            }

            // Create new server card
            const newServerCol = document.createElement('div');
            newServerCol.className = 'col-md-4 mb-4 server-card-add';

            // HTML for the new card
            newServerCol.innerHTML = `
               <div class="card server-card-3d h-100">
                   <div class="card-header d-flex justify-content-between align-items-center">
                       <h5 class="mb-0" data-server-name="${serverName}">
                           <span class="server-status-indicator status-${data.status || 'stopped'}"></span>
                           ${serverName}
                           
                           <div class="server-quick-actions ms-2 d-inline-flex">
                               ${data.status === 'running' ? `
                                   <button class="btn btn-sm btn-link text-light p-0 ms-1" onclick="restartServer('${serverName}')" title="Restart Server">
                                       <i class="bi bi-arrow-clockwise"></i>
                                   </button>
                                   <button class="btn btn-sm btn-link text-light p-0 ms-1" onclick="stopServer('${serverName}')" title="Stop Server">
                                       <i class="bi bi-stop-fill"></i>
                                   </button>
                               ` : `
                                   <button class="btn btn-sm btn-link text-light p-0 ms-1" onclick="startServer('${serverName}')" title="Start Server">
                                       <i class="bi bi-play-fill"></i>
                                   </button>
                               `}
                               
                               ${document.body.hasAttribute('data-is-admin') ? `
                                   <button class="btn btn-sm btn-link text-danger p-0 ms-1" onclick="confirmDeleteServer('${serverName}')" title="Delete Server">
                                       <i class="bi bi-trash"></i>
                                   </button>
                               ` : ''}
                           </div>
                       </h5>
                       <span class="badge bg-${data.status === 'running' ? 'success' : 'danger'}">
                           ${data.status || 'stopped'}
                       </span>
                   </div>
                   <div class="card-body">
                       <div class="d-flex align-items-center mb-3">
                           <i class="bi bi-globe me-2 text-muted"></i>
                           <div>
                               <div class="text-muted small">Server IP</div>
                               <div class="server-ip-display">${window.location.hostname}</div>
                           </div>
                       </div>
                       
                       <div class="d-flex align-items-center mb-3">
                           <i class="bi bi-key me-2 text-muted"></i>
                           <div>
                               <div class="text-muted small">Server Password</div>
                               <div class="d-flex align-items-center">
                                   <span id="server-password-${serverName}" class="password-hidden">
                                       ${data.server_password ? '•••••••••' : 'None'}
                                   </span>
                                   <i class="bi bi-eye password-toggle ms-2" onclick="togglePassword('server-password-${serverName}', '${data.server_password || ''}')"></i>
                               </div>
                           </div>
                       </div>
                       
                       <div class="d-flex align-items-center mb-3">
                           <i class="bi bi-shield-lock me-2 text-muted"></i>
                           <div>
                               <div class="text-muted small">Admin Password</div>
                               <div class="d-flex align-items-center">
                                   <span id="admin-password-${serverName}" class="password-hidden">•••••••••</span>
                                   <i class="bi bi-eye password-toggle ms-2" onclick="togglePassword('admin-password-${serverName}', '${data.admin_password || ''}')"></i>
                               </div>
                           </div>
                       </div>
                       
                       <div class="d-flex align-items-center mb-3">
                           <i class="bi bi-ethernet me-2 text-muted"></i>
                           <div>
                               <div class="text-muted small">Game Port</div>
                               <div>${data.port || ''}</div>
                           </div>
                       </div>
                       
                       <div class="d-flex align-items-center mb-3">
                           <i class="bi bi-broadcast me-2 text-muted"></i>
                           <div>
                               <div class="text-muted small">Query Port</div>
                               <div>${data.query_port || ''}</div>
                           </div>
                       </div>
                       
                       <div class="d-flex align-items-center mb-3">
                           <i class="bi bi-calendar-event me-2 text-muted"></i>
                           <div>
                               <div class="text-muted small">Created</div>
                               <div>${data.created_at || new Date().toLocaleString()}</div>
                           </div>
                       </div>
                       
                       ${data.status === 'running' ? `
                           <hr>
                           <h6 class="text-primary mb-3"><i class="bi bi-graph-up me-2"></i>Server Usage</h6>
                           
                           <!-- CPU Usage -->
                           <div class="mb-2">
                               <div class="d-flex justify-content-between align-items-center mb-1">
                                   <span class="text-muted small">CPU Usage</span>
                                   <span class="small server-cpu-${serverName}">0%</span>
                               </div>
                               <div class="progress" style="height: 6px;">
                                   <div class="progress-bar bg-primary server-cpu-progress-${serverName}" role="progressbar" style="width: 0%"></div>
                               </div>
                           </div>
                           
                           <!-- Memory Usage -->
                           <div class="mb-2">
                               <div class="d-flex justify-content-between align-items-center mb-1">
                                   <span class="text-muted small">Memory</span>
                                   <span class="small server-memory-${serverName}">0 MB</span>
                               </div>
                               <div class="progress" style="height: 6px;">
                                   <div class="progress-bar bg-success server-memory-progress-${serverName}" role="progressbar" style="width: 0%"></div>
                               </div>
                           </div>
                           
                           <!-- Disk Usage -->
                           <div class="mb-2">
                               <div class="d-flex justify-content-between align-items-center mb-1">
                                   <span class="text-muted small">Disk Usage</span>
                                   <span class="small server-disk-${serverName}">0 MB</span>
                               </div>
                               <div class="progress" style="height: 6px;">
                                   <div class="progress-bar bg-warning server-disk-progress-${serverName}" role="progressbar" style="width: 0%"></div>
                               </div>
                           </div>
                           
                           <!-- Network -->
                           <div class="mb-2">
                               <div class="d-flex justify-content-between align-items-center mb-1">
                                   <span class="text-muted small">Network</span>
                                   <span class="small server-network-${serverName}">0 KB/s</span>
                               </div>
                               <div class="progress" style="height: 6px;">
                                   <div class="progress-bar bg-info server-network-progress-${serverName}" role="progressbar" style="width: 0%"></div>
                               </div>
                           </div>
                           
                           <!-- Uptime -->
                           <div class="d-flex align-items-center">
                               <i class="bi bi-clock-history me-2 text-muted small"></i>
                               <div class="small">
                                   <span class="text-muted">Uptime:</span>
                                   <span class="server-uptime-${serverName}">00:00:00</span>
                               </div>
                           </div>
                       ` : ''}
                   </div>
                   <div class="card-footer">
                       <a href="/server/control/${serverName}" class="btn btn-info btn-3d w-100">
                           <i class="bi bi-gear-fill me-2"></i> Manage
                       </a>
                   </div>
               </div>
           `;

            // Add to DOM
            serverRow.appendChild(newServerCol);

            // Setup card toggle functionality
            const newCard = newServerCol.querySelector('.server-card-3d');
            setupCardToggle(newCard);

            // Also add to server stats table if present
            const statsTable = document.querySelector('#servers-stats-table');
            if (statsTable) {
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                   <td>
                       <div class="d-flex align-items-center">
                           <span class="server-status-indicator status-${data.status || 'stopped'} me-2"></span>
                           ${serverName}
                       </div>
                   </td>
                   <td>
                       <span class="badge bg-${data.status === 'running' ? 'success' : 'danger'}">
                           ${data.status || 'stopped'}
                       </span>
                   </td>
                   <td class="server-cpu-${serverName}">--</td>
                   <td class="server-memory-${serverName}">--</td>
                   <td class="server-disk-${serverName}">--</td>
                   <td class="server-network-${serverName}">--</td>
                   <td class="server-uptime-${serverName}">--</td>
               `;
                statsTable.appendChild(newRow);
            }

            // Update dashboard counters
            updateDashboardCounts();
        }

        function removeServerCard(serverName) {
            // Find all server cards with this name
            const serverCards = document.querySelectorAll(`h5[data-server-name="${serverName}"]`);

            serverCards.forEach(nameEl => {
                const card = nameEl.closest('.col-md-4');
                if (card) {
                    // Add the removal animation class
                    card.classList.add('server-card-remove');

                    // Remove after animation
                    setTimeout(() => {
                        card.remove();

                        // If no more servers, show the "no servers" message
                        const serverRow = document.querySelector('#servers-pane .row');
                        if (serverRow && !serverRow.querySelector('.col-md-4')) {
                            const noServersMsg = document.createElement('div');
                            noServersMsg.className = 'alert alert-info';
                            noServersMsg.innerHTML = '<i class="bi bi-info-circle me-2"></i> No servers have been created yet.';

                            // Insert before the row
                            serverRow.parentNode.insertBefore(noServersMsg, serverRow);
                        }
                    }, 500);
                }
            });

            // Remove from stats table
            const statsTable = document.querySelector('#servers-stats-table');
            if (statsTable) {
                const serverRows = statsTable.querySelectorAll('tr');
                serverRows.forEach(row => {
                    const nameCell = row.querySelector('td:first-child');
                    if (nameCell && nameCell.textContent.includes(serverName)) {
                        row.remove();
                    }
                });
            }

            // Update dashboard counters
            updateDashboardCounts();
        }

        function updateDashboardCounts() {
            // Count total and running servers
            const totalServers = document.querySelectorAll('.server-card-3d').length;
            const runningServers = document.querySelectorAll('.badge.bg-success').length;

            // Update active servers counter in stats
            const activeServersEl = document.getElementById('active-servers');
            if (activeServersEl) {
                activeServersEl.textContent = runningServers;
            }
        }

        function setupCardToggle(card) {
            // Store original content
            const cardBody = card.querySelector('.card-body');
            const cardFooter = card.querySelector('.card-footer');
            const cardHeader = card.querySelector('.card-header');
            const originalContent = cardBody.innerHTML;

            // Create collapsed version
            let collapsedContent = '';
            const serverName = cardHeader.querySelector('[data-server-name]').getAttribute('data-server-name');
            collapsedContent = `
    <div class="d-flex align-items-center">
      <i class="bi bi-clock-history me-2 text-muted small"></i>
      <div class="small">
        <span class="text-muted">Uptime:</span>
        <span class="server-uptime-${serverName}">--:--:--</span>
      </div>
    </div>
  `;

            // Create toggle function
            const toggleCardState = (e) => {
                // Prevent toggling if clicking interactive elements
                if (e && (
                    e.target.closest('.server-quick-actions') ||
                    e.target.closest('a') ||
                    e.target.closest('.copyable') ||
                    e.target.closest('.copy-icon') ||
                    e.target.classList.contains('copyable') ||
                    e.target.classList.contains('copy-icon') ||
                    e.target.classList.contains('password-toggle') ||
                    e.target.closest('.password-toggle') ||
                    e.target.classList.contains('bi-eye') ||
                    e.target.classList.contains('bi-eye-slash')
                )) {
                    return;
                }

                if (card.classList.contains('card-collapsed')) {
                    // Expand the card
                    cardBody.innerHTML = originalContent;
                    cardBody.classList.remove('py-0');
                    cardBody.style.padding = '';
                    if (cardFooter) cardFooter.style.display = '';
                    card.classList.remove('card-collapsed');
                    updateServerIpDisplay('server-ip-display');
                    // Re-setup copyable elements
                    setTimeout(() => {
                        enableCopyToClipboard();
                    }, 50);
                } else {
                    // Collapse the card
                    cardBody.innerHTML = collapsedContent;
                    cardBody.classList.add('py-0');
                    cardBody.style.padding = '0 1.5rem';
                    if (cardFooter) cardFooter.style.display = 'none';
                    card.classList.add('card-collapsed');
                }
            };
            card.addEventListener('click', toggleCardState);

            // Initially collapse the card
            toggleCardState();
        }

        function initCreationSessionsStream() {
            if (creationSessionsStream) {
                creationSessionsStream.close();
            }

            creationSessionsStream = new EventSource('/api/creation-sessions-stream');

            creationSessionsStream.onopen = function () {
                console.log('Creation sessions stream connected');
            };

            creationSessionsStream.addEventListener('sessions_update', function (event) {
                const data = JSON.parse(event.data);
                updateCreationSessionsUI(data.sessions);
            });

            creationSessionsStream.addEventListener('heartbeat', function (event) {
                // Silent heartbeat
            });

            creationSessionsStream.onerror = function (error) {
                console.error('Creation sessions stream error:', error);
                setTimeout(function () {
                    initCreationSessionsStream();
                }, 5000);
            };
        }

        function updateCreationSessionsUI(sessions) {
            sessions.forEach(session => {
                if (session.status === 'completed') {
                    const serverExists = cachedServersList.some(s => s.name === session.server_name);

                    if (serverExists && !document.querySelector(`h5[data-server-name="${session.server_name}"]`)) {
                        fetch(`/api/server/${session.server_name}/status`)
                            .then(response => response.json())
                            .then(statusData => {
                                handleNewServer(session.server_name, {
                                    name: session.server_name,
                                    status: statusData.status || 'stopped',
                                    created_at: new Date().toLocaleString()
                                });
                            });
                    }
                }
            });

            if (document.querySelector('#queue-tab.active')) {
                updateQueueTable(sessions);
            }
        }

        // Function to fetch and display queue servers - updated version
        function fetchQueueServers() {
            // Show loading state
            document.getElementById('queue-servers-table').innerHTML = `
      <tr>
          <td colspan="5" class="text-center py-3">
              <i class="bi bi-hourglass-split me-2"></i> Loading...
          </td>
      </tr>
  `;

            // Fetch the data
            fetch('/api/creation-sessions')
                .then(response => response.json())
                .then(data => {
                    updateQueueTable(data.sessions);
                })
                .catch(error => {
                    console.error('Error fetching queue data:', error);
                    document.getElementById('queue-servers-table').innerHTML = `
              <tr>
                  <td colspan="5" class="text-center text-danger py-3">
                      <i class="bi bi-exclamation-triangle me-2"></i> Error loading data
                  </td>
              </tr>
          `;
                });
        }

        // Replace server management functions
        function startServer(serverName) {
            Swal.fire({
                title: 'Start Server',
                text: `Are you sure you want to start server "${serverName}"?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#6c5ce7',
                cancelButtonColor: '#2d3748',
                confirmButtonText: 'Confirm',
                background: '#1e1e1e',
                color: '#f5f6fa',
            }).then((result) => {
                if (result.isConfirmed) {
                    // Show loading spinner
                    Swal.fire({
                        title: 'Starting Server',
                        html: 'Please wait...',
                        didOpen: () => {
                            Swal.showLoading();
                        },
                        allowOutsideClick: false,
                        background: '#1e1e1e',
                        color: '#f5f6fa'
                    });

                    $.ajax({
                        url: `/server/${serverName}/start`,
                        type: 'POST',
                        success: function (response) {
                            if (response.success) {
                                Swal.fire({
                                    toast: true,
                                    position: "top-end",
                                    icon: 'success',
                                    title: 'Server started successfully',
                                    showConfirmButton: false,
                                    timer: 3000,
                                    timerProgressBar: true,
                                    background: '#1e1e1e',
                                    color: '#f5f6fa'
                                });

                                // Update UI immediately
                                updateServerUI(serverName, 'started');
                            } else {
                                Swal.fire({
                                    toast: true,
                                    position: "top-end",
                                    icon: 'error',
                                    title: 'Error starting server: ' + response.message,
                                    showConfirmButton: false,
                                    timer: 3000,
                                    timerProgressBar: true,
                                    background: '#1e1e1e',
                                    color: '#f5f6fa'
                                });
                            }
                        },
                        error: function () {
                            Swal.fire({
                                toast: true,
                                position: "top-end",
                                icon: 'error',
                                title: 'Error communicating with the server',
                                showConfirmButton: false,
                                timer: 3000,
                                timerProgressBar: true,
                                background: '#1e1e1e',
                                color: '#f5f6fa'
                            });
                        }
                    });
                }
            });
        }

        function stopServer(serverName) {
            Swal.fire({
                title: 'Stop Server',
                text: `Are you sure you want to stop server "${serverName}"?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#6c5ce7',
                cancelButtonColor: '#2d3748',
                confirmButtonText: 'Confirm',
                background: '#1e1e1e',
                color: '#f5f6fa',
            }).then((result) => {
                if (result.isConfirmed) {
                    // Show loading spinner
                    Swal.fire({
                        title: 'Stopping Server',
                        html: 'Please wait...',
                        didOpen: () => {
                            Swal.showLoading();
                        },
                        allowOutsideClick: false,
                        background: '#1e1e1e',
                        color: '#f5f6fa'
                    });

                    $.ajax({
                        url: `/server/${serverName}/stop`,
                        type: 'POST',
                        success: function (response) {
                            if (response.success) {
                                Swal.fire({
                                    toast: true,
                                    position: "top-end",
                                    icon: 'success',
                                    title: 'Server stopped successfully',
                                    showConfirmButton: false,
                                    timer: 1500,
                                    timerProgressBar: true,
                                    background: '#1e1e1e',
                                    color: '#f5f6fa'
                                });

                                // Update UI immediately
                                updateServerUI(serverName, 'stopping');
                            } else {
                                Swal.fire({
                                    toast: true,
                                    position: "top-end",
                                    icon: 'error',
                                    title: 'Error stopping server: ' + response.message,
                                    showConfirmButton: false,
                                    timer: 3000,
                                    timerProgressBar: true,
                                    background: '#1e1e1e',
                                    color: '#f5f6fa'
                                });
                            }
                        },
                        error: function () {
                            Swal.fire({
                                toast: true,
                                position: "top-end",
                                icon: 'error',
                                title: 'Error communicating with the server',
                                showConfirmButton: false,
                                timer: 3000,
                                timerProgressBar: true,
                                background: '#1e1e1e',
                                color: '#f5f6fa'
                            });
                        }
                    });
                }
            });
        }

        function restartServer(serverName) {
            Swal.fire({
                title: 'Restart Server',
                text: `Are you sure you want to restart server "${serverName}"?`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#6c5ce7',
                cancelButtonColor: '#2d3748',
                confirmButtonText: 'Confirm',
                background: '#1e1e1e',
                color: '#f5f6fa',
            }).then((result) => {
                if (result.isConfirmed) {
                    // Show loading spinner
                    Swal.fire({
                        title: 'Restarting Server',
                        html: 'Please wait...',
                        didOpen: () => {
                            Swal.showLoading();
                        },
                        allowOutsideClick: false,
                        background: '#1e1e1e',
                        color: '#f5f6fa'
                    });

                    $.ajax({
                        url: `/server/${serverName}/restart`,
                        type: 'POST',
                        success: function (response) {
                            if (response.success) {
                                Swal.fire({
                                    toast: true,
                                    position: "top-end",
                                    icon: 'success',
                                    title: 'Server restarted successfully',
                                    showConfirmButton: false,
                                    timer: 1500,
                                    timerProgressBar: true,
                                    background: '#1e1e1e',
                                    color: '#f5f6fa'
                                });

                                // Update UI immediately
                                updateServerUI(serverName, 'restarting');
                            } else {
                                Swal.fire({
                                    toast: true,
                                    position: "top-end",
                                    icon: 'error',
                                    title: 'Error restarting server: ' + response.message,
                                    showConfirmButton: false,
                                    timer: 3000,
                                    timerProgressBar: true,
                                    background: '#1e1e1e',
                                    color: '#f5f6fa'
                                });
                            }
                        },
                        error: function () {
                            Swal.fire({
                                toast: true,
                                position: "top-end",
                                icon: 'error',
                                title: 'Error communicating with the server',
                                showConfirmButton: false,
                                timer: 3000,
                                timerProgressBar: true,
                                background: '#1e1e1e',
                                color: '#f5f6fa'
                            });
                        }
                    });
                }
            });
        }

        function confirmDeleteServer(serverName) {
            Swal.fire({
                title: 'Delete Server',
                html: `<strong class="text-danger">WARNING:</strong> Are you sure you want to DELETE server
"${serverName}"?<br><br>This action cannot be undone and will permanently remove the server and all its data.`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#e74c3c',
                cancelButtonColor: '#2d3748',
                confirmButtonText: 'Continue',
                cancelButtonText: 'Cancel',
                focusCancel: true,
                background: '#1e1e1e',
                color: '#f5f6fa',
            }).then((result) => {
                if (result.isConfirmed) {
                    Swal.fire({
                        title: 'FINAL WARNING',
                        html: `This will <strong class="text-danger">PERMANENTLY DELETE</strong> server "${serverName}" and <strong
class="text-danger">ALL</strong> its data.<br><br>Are you <strong>ABSOLUTELY</strong> sure?`,
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#e74c3c',
                        cancelButtonColor: '#2d3748',
                        confirmButtonText: 'Confirm',
                        cancelButtonText: 'Cancel',
                        background: '#1e1e1e',
                        color: '#f5f6fa',
                    }).then((secondResult) => {
                        if (secondResult.isConfirmed) {
                            // Show loading spinner
                            Swal.fire({
                                title: 'Deleting Server',
                                html: 'Please wait...',
                                didOpen: () => {
                                    Swal.showLoading();
                                },
                                allowOutsideClick: false,
                                background: '#1e1e1e',
                                color: '#f5f6fa'
                            });

                            $.ajax({
                                url: `/server/${serverName}/delete`,
                                type: 'POST',
                                success: function (response) {
                                    if (response.success) {
                                        Swal.fire({
                                            toast: true,
                                            position: "top-end",
                                            icon: 'success',
                                            title: 'Server deleted successfully',
                                            showConfirmButton: false,
                                            timer: 1500,
                                            timerProgressBar: true,
                                            background: '#1e1e1e',
                                            color: '#f5f6fa'
                                        });

                                        // Remove server from UI
                                        removeServerCard(serverName);
                                    } else {
                                        Swal.fire({
                                            toast: true,
                                            position: "top-end",
                                            icon: 'error',
                                            title: 'Error deleting server: ' + response.message,
                                            showConfirmButton: false,
                                            timer: 3000,
                                            timerProgressBar: true,
                                            background: '#1e1e1e',
                                            color: '#f5f6fa'
                                        });
                                    }
                                },
                                error: function () {
                                    Swal.fire({
                                        toast: true,
                                        position: "top-end",
                                        icon: 'error',
                                        title: 'Error communicating with the server',
                                        showConfirmButton: false,
                                        timer: 3000,
                                        timerProgressBar: true,
                                        background: '#1e1e1e',
                                        color: '#f5f6fa'
                                    });
                                }
                            });
                        }
                    });
                }
            });
        }

        // Update server UI function - improved version
        function updateServerUI(serverName, status) {
            // Update status indicators and badges
            document.querySelectorAll(`.server-card-3d h5[data-server-name="${serverName}"] .server-status-indicator`)
                .forEach(indicator => {
                    indicator.className = `server-status-indicator status-${status}`;
                });

            // For server table rows
            document.querySelectorAll('#servers-stats-table tr').forEach(row => {
                const nameCell = row.querySelector('td:first-child');
                if (nameCell && nameCell.textContent.includes(serverName)) {
                    const indicator = row.querySelector('.server-status-indicator');
                    if (indicator) {
                        indicator.className = `server-status-indicator status-${status} me-2`;
                    }
                }
            });

            // Update status badges
            const statusBadges = document.querySelectorAll(`.server-card-3d h5[data-server-name="${serverName}"]`)
                .forEach(nameEl => {
                    const card = nameEl.closest('.card');
                    if (!card) return;

                    const badge = card.querySelector('.badge');
                    if (!badge) return;

                    badge.textContent = status;
                    badge.className = 'badge';

                    switch (status) {
                        case 'running':
                            badge.classList.add('bg-success');
                            break;
                        case 'loading':
                        case 'started':
                            badge.classList.add('bg-info');
                            break;
                        case 'restarting':
                        case 'stopping':
                            badge.classList.add('bg-warning');
                            break;
                        case 'stopped':
                        case 'failed':
                            badge.classList.add('bg-danger');
                            break;
                        default:
                            badge.classList.add('bg-secondary');
                    }
                });

            // Update action buttons
            updateServerActionButtons(serverName, status);

            // Handle server usage statistics visibility
            const serverCards = document.querySelectorAll(`.server-card-3d`);
            serverCards.forEach(card => {
                const cardHeader = card.querySelector('.card-header');
                const nameElement = cardHeader.querySelector(`h5[data-server-name="${serverName}"]`);

                if (nameElement) {
                    const cardBody = card.querySelector('.card-body');

                    // If the server is now running, we need to update the card
                    if (status === 'running' || status === 'started') {
                        // Check if this card is collapsed
                        if (card.classList.contains('card-collapsed')) {
                            // For collapsed cards, we need to add the uptime element
                            const uptimeElement = cardBody.querySelector(`.server-uptime-${serverName}`);
                            if (!uptimeElement) {
                                cardBody.innerHTML = `
                  <div class="d-flex align-items-center py-2">
                      <i class="bi bi-clock-history me-2 text-muted small"></i>
                      <div class="small">
                          <span class="text-muted">Uptime:</span>
                          <span class="server-uptime-${serverName}">00:00:00</span>
                      </div>
                  </div>
              `;
                            }
                        } else {
                            // For expanded cards, check if usage statistics are present
                            const usageStats = cardBody.querySelector('hr');
                            if (!usageStats) {
                                // Append usage statistics section
                                cardBody.innerHTML += `
                  <hr>
                  <h6 class="text-primary mb-3"><i class="bi bi-graph-up me-2"></i>Server Usage</h6>

                  <!-- CPU Usage -->
                  <div class="mb-2">
                      <div class="d-flex justify-content-between align-items-center mb-1">
                          <span class="text-muted small">CPU Usage</span>
                          <span class="small server-cpu-${serverName}">0%</span>
                      </div>
                      <div class="progress" style="height: 6px;">
                          <div class="progress-bar bg-primary server-cpu-progress-${serverName}"
                              role="progressbar" style="width: 0%"></div>
                      </div>
                  </div>

                  <!-- Memory Usage -->
                  <div class="mb-2">
                      <div class="d-flex justify-content-between align-items-center mb-1">
                          <span class="text-muted small">Memory</span>
                          <span class="small server-memory-${serverName}">0 MB</span>
                      </div>
                      <div class="progress" style="height: 6px;">
                          <div class="progress-bar bg-success server-memory-progress-${serverName}"
                              role="progressbar" style="width: 0%"></div>
                      </div>
                  </div>

                  <!-- Disk Usage -->
                  <div class="mb-2">
                      <div class="d-flex justify-content-between align-items-center mb-1">
                          <span class="text-muted small">Disk Usage</span>
                          <span class="small server-disk-${serverName}">0 MB</span>
                      </div>
                      <div class="progress" style="height: 6px;">
                          <div class="progress-bar bg-warning server-disk-progress-${serverName}"
                              role="progressbar" style="width: 0%"></div>
                      </div>
                  </div>

                  <!-- Network -->
                  <div class="mb-2">
                      <div class="d-flex justify-content-between align-items-center mb-1">
                          <span class="text-muted small">Network</span>
                          <span class="small server-network-${serverName}">0 KB/s</span>
                      </div>
                      <div class="progress" style="height: 6px;">
                          <div class="progress-bar bg-info server-network-progress-${serverName}"
                              role="progressbar" style="width: 0%"></div>
                      </div>
                  </div>

                  <!-- Uptime -->
                  <div class="d-flex align-items-center">
                      <i class="bi bi-clock-history me-2 text-muted small"></i>
                      <div class="small">
                          <span class="text-muted">Uptime:</span>
                          <span class="server-uptime-${serverName}">00:00:00</span>
                      </div>
                  </div>
              `;
                            }
                        }
                    } else if (status === 'stopped' || status === 'failed') {
                        // If the server is now stopped, we should remove usage statistics
                        if (card.classList.contains('card-collapsed')) {
                            // For collapsed cards, remove uptime display
                            cardBody.innerHTML = '';
                        }
                    }
                }
            });

            // Also update the servers stats table row
            const tableRows = document.querySelectorAll('#servers-stats-table tr');
            tableRows.forEach(row => {
                const nameCell = row.querySelector('td:first-child');
                if (nameCell && nameCell.textContent.includes(serverName)) {
                    const statusCell = row.querySelector('td:nth-child(2) .badge');
                    if (statusCell) {
                        statusCell.className = `badge bg-${status === 'running' ? 'success' : 'danger'}`;
                        statusCell.textContent = status;
                    }
                }
            });

            // Update dashboard counts
            updateDashboardCounts();
        }

        // Function to update server action buttons
        function updateServerActionButtons(serverName, status) {
            const quickActionsDivs = document.querySelectorAll(`.server-quick-actions`);

            quickActionsDivs.forEach(actionsDiv => {
                // Get the parent element that contains the server name
                const serverNameElement = actionsDiv.closest('h5');

                // Only update if this is the right server
                if (!serverNameElement || serverNameElement.getAttribute('data-server-name') !== serverName) return;

                // Clear existing buttons
                actionsDiv.innerHTML = '';

                // Add appropriate buttons based on status
                if (status === 'running' || status === 'loading' || status === 'started') {
                    // For running servers, add restart and stop buttons
                    actionsDiv.innerHTML = `
<button class="btn btn-sm btn-link text-light p-0 ms-1" onclick="restartServer('${serverName}')"
title="Restart Server">
<i class="bi bi-arrow-clockwise"></i>
</button>
<button class="btn btn-sm btn-link text-light p-0 ms-1" onclick="stopServer('${serverName}')" title="Stop Server">
<i class="bi bi-stop-fill"></i>
</button>
`;
                } else {
                    // For stopped servers, add start button
                    actionsDiv.innerHTML = `
<button class="btn btn-sm btn-link text-light p-0 ms-1" onclick="startServer('${serverName}')" title="Start Server">
<i class="bi bi-play-fill"></i>
</button>
`;
                }

                // Add delete button for admins
                const isAdmin = document.body.hasAttribute('data-is-admin') ||
                    document.body.hasAttribute('data-clear-cache');
                if (isAdmin) {
                    actionsDiv.innerHTML += `
<button class="btn btn-sm btn-link text-danger p-0 ms-1" onclick="confirmDeleteServer('${serverName}')"
title="Delete Server">
<i class="bi bi-trash"></i>
</button>
`;
                }
            });
        }

        // Function to update all stats at once
        function updateAllStats(data) {
            // Update CPU stats
            document.getElementById('cpu-usage').textContent = data.cpu.usage + '%';
            document.getElementById('cpu-progress').style.width = data.cpu.usage + '%';

            // Update Memory stats
            document.getElementById('memory-usage').textContent = data.memory.used + ' / ' + data.memory.total + ' GB';
            document.getElementById('memory-progress').style.width = data.memory.percentage + '%';

            // Update Disk stats
            document.getElementById('disk-usage').textContent = data.disk.used + ' / ' + data.disk.total + ' GB';
            document.getElementById('disk-progress').style.width = data.disk.percentage + '%';

            // Update Network stats
            document.getElementById('network-traffic').textContent = data.network.traffic + ' MB/s';
            document.getElementById('network-progress').style.width = Math.min(data.network.percentage, 100) + '%';

            // Update other stats
            document.getElementById('uptime').textContent = data.uptime;
            document.getElementById('active-servers').textContent = data.active_servers;
            document.getElementById('load-average').textContent = data.load_average;
            document.getElementById('temperature').textContent = data.temperature + '°C';

            // Update last updated time
            document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();

            // Update per-server statistics if available
            if (data.servers) {
                for (const [serverName, serverStats] of Object.entries(data.servers)) {
                    // Update stats in server cards
                    const cpuCardElements = document.querySelectorAll(`.server-cpu-${serverName}`);
                    const memoryCardElements = document.querySelectorAll(`.server-memory-${serverName}`);
                    const diskCardElements = document.querySelectorAll(`.server-disk-${serverName}`);
                    const networkCardElements = document.querySelectorAll(`.server-network-${serverName}`);
                    const uptimeCardElements = document.querySelectorAll(`.server-uptime-${serverName}`);

                    // Update all instances of this server's stats
                    cpuCardElements.forEach(el => {
                        el.textContent = serverStats.cpu_usage + '%';
                    });

                    memoryCardElements.forEach(el => {
                        el.textContent = serverStats.memory_usage + ' MB';
                    });

                    diskCardElements.forEach(el => {
                        el.textContent = serverStats.disk_usage + ' MB';
                    });

                    networkCardElements.forEach(el => {
                        el.textContent = serverStats.network_traffic + ' KB/s';
                    });

                    uptimeCardElements.forEach(el => {
                        el.textContent = serverStats.uptime;
                    });

                    // Update progress bars
                    const cpuProgressEl = document.querySelector(`.server-cpu-progress-${serverName}`);
                    const memoryProgressEl = document.querySelector(`.server-memory-progress-${serverName}`);
                    const diskProgressEl = document.querySelector(`.server-disk-progress-${serverName}`);
                    const networkProgressEl = document.querySelector(`.server-network-progress-${serverName}`);

                    if (cpuProgressEl) cpuProgressEl.style.width = serverStats.cpu_usage + '%';
                    if (memoryProgressEl) memoryProgressEl.style.width = serverStats.memory_percentage + '%';
                    if (diskProgressEl) diskProgressEl.style.width = serverStats.disk_percentage + '%';
                    if (networkProgressEl) networkProgressEl.style.width = Math.min(serverStats.network_percentage, 100) + '%';
                }
            }
        }

        // Remember which tab was active
        const activateTab = (tabId) => {
            const tab = document.getElementById(tabId);
            if (tab) {
                const tabInstance = new bootstrap.Tab(tab);
                tabInstance.show();
                // Store the active tab in localStorage
                localStorage.setItem('activeDashboardTab', tabId);
            }
        };

        // Initialize status and stats streams
        function initStreams() {
            // Close existing streams if they exist
            if (statusStream) {
                statusStream.close();
            }

            if (statsStream) {
                statsStream.close();
            }

            // Initialize status stream
            statusStream = new EventSource('/api/server-status-stream');

            // Initialize stats stream
            statsStream = new EventSource('/api/server-stats-stream');

            // Handle status stream events
            statusStream.onopen = function () {
                console.log('Status stream connected');
            };

            statusStream.addEventListener('status_update', function (event) {
                const data = JSON.parse(event.data);
                console.log('Received status updates');

                // Update UI for each server
                const statuses = data.statuses;
                for (const [serverName, status] of Object.entries(statuses)) {
                    updateServerCard(serverName, status);
                }
            });

            statusStream.addEventListener('heartbeat', function (event) {
                console.log('Status heartbeat received:', event.data);
            });

            statusStream.onerror = function (error) {
                console.error('Status stream error:', error);
                // Try to reconnect after a few seconds if connection is lost
                setTimeout(function () {
                    initStreams(); // Re-initialize the streams
                }, 5000);
            };

            // Handle stats stream events
            statsStream.onopen = function () {
                console.log('Stats stream connected');
            };

            statsStream.addEventListener('stats_update', function (event) {
                const data = JSON.parse(event.data);
                console.log('Received stats update');
                updateAllStats(data);

                // Update server cards with stats data
                if (data.servers) {
                    for (const [serverName, serverStats] of Object.entries(data.servers)) {
                        const status = document.querySelector(`h5[data-server-name="${serverName}"]`) ?
                            document.querySelector(`.badge:has(+ h5[data-server-name="${serverName}"])`).textContent : 'unknown';
                        updateServerCard(serverName, status, data);
                    }
                }
            });

            statsStream.addEventListener('heartbeat', function (event) {
                console.log('Stats heartbeat received:', event.data);
            });

            statsStream.onerror = function (error) {
                console.error('Stats stream error:', error);
                // Try to reconnect after a few seconds if connection is lost
                setTimeout(function () {
                    initStreams(); // Re-initialize the streams
                }, 5000);
            };
        }

        // Visibility change tracking
        let isTabActive = true;

        function handleVisibilityChange() {
            isTabActive = document.visibilityState === 'visible';
            console.log('Visibility changed:', isTabActive ? 'visible' : 'hidden');

            if (isTabActive) {
                // Re-establish the streams when tab becomes visible
                initStreams();
                initCreationSessionsStream();
            } else {
                // Close the streams when tab is not visible
                if (statusStream) {
                    statusStream.close();
                    statusStream = null;
                }

                if (statsStream) {
                    statsStream.close();
                    statsStream = null;
                }

                if (creationSessionsStream) {
                    creationSessionsStream.close();
                    creationSessionsStream = null;
                }
            }
        }

        // Document ready handler
        document.addEventListener('DOMContentLoaded', function () {
            initServersListStream();
            enableCopyToClipboard();

            // Handle visibility changes
            document.addEventListener('visibilitychange', handleVisibilityChange);

            // Get all server cards
            const serverCards = document.querySelectorAll('.server-card-3d');

            // Process each card for collapsible functionality
            serverCards.forEach(card => {
                setupCardToggle(card);
            });

            // Restore previously active tab on page load
            const activeTabId = localStorage.getItem('activeDashboardTab');
            if (activeTabId) {
                activateTab(activeTabId);
            }

            // Add event listeners to tabs to store active state
            document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', (event) => {
                    localStorage.setItem('activeDashboardTab', event.target.id);
                });
            });

            // Add event listener for the refresh button
            document.getElementById('refresh-stats').addEventListener('click', function () {
                // Close and reopen the stats stream to get fresh data
                if (statsStream) {
                    statsStream.close();
                    statsStream = null;
                }
                statsStream = new EventSource('/api/server-stats-stream');

                statsStream.addEventListener('stats_update', function (event) {
                    const data = JSON.parse(event.data);
                    updateAllStats(data);
                    // Close the stream after receiving one update
                    setTimeout(() => {
                        statsStream.close();
                        statsStream = new EventSource('/api/server-stats-stream');
                    }, 500);
                });
            });

            // Update server IP display
            updateServerIpDisplay('server-ip-display');

            // Initialize the status and stats streams
            initStreams();

            // Initialize creation sessions stream
            initCreationSessionsStream();

            // Initial load of queue data
            if (document.getElementById('queue-tab')) {
                document.getElementById('queue-tab').addEventListener('shown.bs.tab', fetchQueueServers);
                document.getElementById('refresh-queue').addEventListener('click', fetchQueueServers);
            }

            // Set up periodic refresh when tab is active
            let queueRefreshInterval = null;

            function setupQueueRefresh() {
                // Clear any existing interval
                if (queueRefreshInterval) {
                    clearInterval(queueRefreshInterval);
                }

                // Set up new interval (refresh every 30 seconds)
                queueRefreshInterval = setInterval(() => {
                    // Only refresh if the queue tab is active
                    const queueTabActive = document.querySelector('#queue-tab.active');
                    if (queueTabActive) {
                        fetchQueueServers();
                    }
                }, 30000);
            }

            // Initial setup
            setupQueueRefresh();

            // Update dashboard counts
            updateDashboardCounts();
        });

        // Function to update the queue table
        function updateQueueTable(sessions) {
            const tableBody = document.getElementById('queue-servers-table');
            const noQueueMessage = document.getElementById('no-queue-message');

            // Filter only running sessions
            const runningSessions = sessions.filter(session => session.status === 'running');

            if (runningSessions.length === 0) {
                tableBody.innerHTML = '';
                noQueueMessage.style.display = 'block';
                return;
            }

            noQueueMessage.style.display = 'none';
            let tableHTML = '';

            runningSessions.forEach(session => {
                // Calculate duration
                const startedAt = new Date(session.started_at * 1000);
                const now = new Date();
                const durationMs = now - startedAt;
                const minutes = Math.floor(durationMs / 60000);
                const seconds = Math.floor((durationMs % 60000) / 1000);
                const duration = `${minutes}m ${seconds}s`;

                tableHTML += `
          <tr>
              <td>${session.server_name || 'Unnamed server'}</td>
              <td><span class="badge bg-info">Creating</span></td>
              <td>${startedAt.toLocaleString()}</td>
              <td>${duration}</td>
              <td>
                  <a href="/server/create/${session.creation_id}" class="btn btn-sm btn-primary">
                      <i class="bi bi-eye"></i> View
                  </a>
              </td>
          </tr>
      `;
            });

            tableBody.innerHTML = tableHTML;
        }

        function syncServerDisplay() {
            const serverNames = new Set(cachedServersList.map(s => s.name));

            document.querySelectorAll('.server-card-3d').forEach(card => {
                const nameEl = card.querySelector('[data-server-name]');
                if (nameEl) {
                    const serverName = nameEl.getAttribute('data-server-name');
                    if (!serverNames.has(serverName)) {
                        removeServerCard(serverName);
                    }
                }
            });
        }

    </script>
    <script>
        // Custom copy function
        function copythe(elemId) {
            const ccid = document.getElementById(elemId).innerText;
            const textarea = document.createElement("textarea");
            textarea.value = ccid;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);

            // Show success notification
            Swal.fire({
                toast: true,
                position: 'top-end',
                icon: 'success',
                title: 'Copied to clipboard!',
                showConfirmButton: false,
                timer: 1500,
                timerProgressBar: true,
                background: '#1e1e1e',
                color: '#f5f6fa'
            });
        }

        // Enhanced enableCopyToClipboard with custom function
        function enableCopyToClipboard() {
            // Set up copy elements with icons
            function setupCopyElements() {
                const copyElements = document.querySelectorAll('.server-ip-display, [id^="server-password-"], [id^="admin-password-"], #gameport, #query_portport');

                copyElements.forEach(element => {
                    // Skip if already processed
                    if (element.classList.contains('copyable')) {
                        element.setAttribute('onclick', `copythe('${element.id}')`);
                        return;
                    }

                    // Add copyable class and ID if missing
                    element.classList.add('copyable');
                    if (!element.id) {
                        element.id = 'copy-' + Math.random().toString(36).substr(2, 9);
                    }
                });
            }

            // Initial setup
            setupCopyElements();

            // Re-setup after card expansion/collapse
            document.addEventListener('click', function (e) {
                if (e.target.closest('.card')) {
                    // Wait for DOM to update after expansion/collapse
                    setTimeout(setupCopyElements, 100);
                }
            });

            // Setup on tab changes
            document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', setupCopyElements);
            });
        }
    </script>
    <script src="{{ url_for('static', filename='js/hostname-to-ip.js') }}"></script>
    <script src="{{ url_for('static', filename='js/cache-buster.js') }}"></script>
</body>

</html>